<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Latein Vokabeltrainer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 1rem;
    }
    .card, .menu, .history {
      background-color: #fff;
      padding: 2rem;
      margin: 1rem auto;
      width: 90%;
      max-width: 700px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    h2, h3 { text-align: center; }
    .button {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    .green { background-color: #4CAF50; color: white; }
    .red { background-color: #f44336; color: white; }
    .grey { background-color: #ccc; color: #666; cursor: not-allowed; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ddd;
    }
    .section-controls {
      text-align: center;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="menu" id="main-menu">
    <h2>Latein Vokabeltrainer</h2>
    <button class="button" onclick="showSectionSelect()">Sektion wählen</button>
    <button class="button" onclick="showHistory()">Lernverlauf anzeigen</button>
    <button class="button red" onclick="resetAllProgress()">Fortschritt zurücksetzen</button>
  </div>

  <div class="card" id="card" style="display:none;">
    <h2 id="card-front">LATIN</h2>
    <div id="card-back" style="display: none;"></div>
    <button class="button" onclick="reveal()">Lösung zeigen</button>
    <div class="section-controls">
      <button id="know-btn" class="button grey" onclick="answered(true)" disabled>Gewusst</button>
      <button id="dont-know-btn" class="button grey" onclick="answered(false)" disabled>Nicht gewusst</button>
    </div>
  </div>

  <div class="card" id="overview" style="display:none;"></div>
  <div class="card" id="section-select" style="display:none;"></div>
  <div class="card history" id="history-view" style="display:none;"></div>

  <script>
    let vocabulary = [];
    let sections = [];
    let pages = {};
    let sectionSize = 25;
    let currentSectionIndex = 0;
    let currentWordIndex = 0;
    let results = {}; // { [vocabIndex]: { right, total } }
    let sessionResults = {};
    let sessionState = null;

    fetch("vocabulary.json")
      .then(r => r.json())
      .then(data => {
        vocabulary = data.vocs;
        pages = data.pages;
        splitSections();
        loadHistory();
        checkSessionResume();
      });

    function checkSessionResume() {
      const saved = localStorage.getItem("sessionState");
      if (saved) {
        if (confirm("Möchtest du deine letzte Lerneinheit fortsetzen?")) {
          sessionState = JSON.parse(saved);
          currentSectionIndex = sessionState.section;
          currentWordIndex = sessionState.index;
          document.getElementById("main-menu").style.display = "none";
          document.getElementById("card").style.display = "block";
          loadCurrentCard();
        } else {
          localStorage.removeItem("sessionState");
          showMenu();
        }
      } else {
        showMenu();
      }
    }

    function showMenu() {
      document.getElementById("main-menu").style.display = "block";
      document.getElementById("card").style.display = "none";
      document.getElementById("overview").style.display = "none";
      document.getElementById("section-select").style.display = "none";
      document.getElementById("history-view").style.display = "none";
    }

    function splitSections() {
      for (let i = 0; i < vocabulary.length; i += sectionSize) {
        sections.push(vocabulary.slice(i, i + sectionSize));
      }
    }

    function showSectionSelect() {
      let html = `<h3>Wähle eine Sektion</h3>`;
      sections.forEach((section, i) => {
        const first = section[0]?.latin;
        const last = section[section.length - 1]?.latin;
        const startIndex = i * sectionSize;
        const pageNumbers = Object.entries(pages)
          .filter(([_, [start, end]]) => start <= startIndex && end >= startIndex)
          .map(([p]) => p).join(', ');
        html += `<button class="button" onclick="selectSection(${i})">${i + 1}: ${first} – ${last} (Seite ${pageNumbers})</button><br>`;
      });
      document.getElementById("section-select").innerHTML = html;
      document.getElementById("section-select").style.display = "block";
      document.getElementById("main-menu").style.display = "none";
    }

    function selectSection(index) {
      currentSectionIndex = index;
      currentWordIndex = 0;
      sessionResults = {};
      showSectionOverview();
    }

    function showSectionOverview() {
      const section = sections[currentSectionIndex];
      let html = `<h3>Sektionsüberblick</h3><table><tr><th>Latein</th><th>Grammatik</th><th>Deutsch</th></tr>`;
      section.forEach(v => {
        html += `<tr><td>${v.latin}
          ${v.sub_voc_one ? `<br><small>${v.sub_voc_one.latin}</small>` : ""}
          ${v.sub_voc_two ? `<br><small>${v.sub_voc_two.latin}</small>` : ""}</td>
          <td>${v.grammar_info || ""}</td>
          <td>${v.german.replace(/\n/g, "<br>")}</td></tr>`;
      });
      html += `</table><button class="button" onclick="startSection()">Sektion starten</button>`;
      document.getElementById("overview").innerHTML = html;
      document.getElementById("overview").style.display = "block";
      document.getElementById("section-select").style.display = "none";
    }

    function startSection() {
      document.getElementById("overview").style.display = "none";
      document.getElementById("card").style.display = "block";
      loadCurrentCard();
    }

    function loadCurrentCard() {
      const section = sections[currentSectionIndex];
      if (!section || currentWordIndex >= section.length) {
        endSection();
        return;
      }
      const voc = section[currentWordIndex];
      document.getElementById("card-front").textContent = voc.latin +
        (voc.sub_voc_one ? " | " + voc.sub_voc_one.latin : "") +
        (voc.sub_voc_two ? ", " + voc.sub_voc_two.latin : "");
      document.getElementById("card-back").innerHTML = generateAnswerHTML(voc);
      document.getElementById("card-back").style.display = "none";
      document.getElementById("know-btn").disabled = true;
      document.getElementById("dont-know-btn").disabled = true;
      document.getElementById("know-btn").className = "button grey";
      document.getElementById("dont-know-btn").className = "button grey";

      // Save session state
      localStorage.setItem("sessionState", JSON.stringify({ section: currentSectionIndex, index: currentWordIndex }));
    }

    function generateAnswerHTML(voc) {
      let html = `<strong>${voc.german.replace(/\n/g, "<br>")}</strong>`;
      if (voc.grammar_info) html += `<br><em>${voc.grammar_info}</em>`;
      if (voc.sub_voc_one) html += `<br><small>${voc.sub_voc_one.latin}: ${voc.sub_voc_one.german}</small>`;
      if (voc.sub_voc_two) html += `<br><small>${voc.sub_voc_two.latin}: ${voc.sub_voc_two.german}</small>`;
      return html;
    }

    function reveal() {
      document.getElementById("card-back").style.display = "block";
      document.getElementById("know-btn").disabled = false;
      document.getElementById("dont-know-btn").disabled = false;
      document.getElementById("know-btn").className = "button green";
      document.getElementById("dont-know-btn").className = "button red";
    }

    function answered(knew) {
      const vocIndex = currentSectionIndex * sectionSize + currentWordIndex;
      if (!results[vocIndex]) results[vocIndex] = { total: 0, right: 0 };
      results[vocIndex].total++;
      if (knew) results[vocIndex].right++;
      sessionResults[vocIndex] = knew;
      saveHistory();
      currentWordIndex++;
      loadCurrentCard();
    }

    function endSection() {
      alert("Sektion abgeschlossen!");
      localStorage.removeItem("sessionState");
      showMenu();
    }

    function saveHistory() {
      localStorage.setItem("vocabResults", JSON.stringify(results));
    }

    function loadHistory() {
      const stored = localStorage.getItem("vocabResults");
      if (stored) results = JSON.parse(stored);
    }

    function showHistory() {
      let html = `<h3>Lernverlauf</h3><table><tr><th>Latein</th><th>Richtig / Gesamt</th><th>%</th></tr>`;
      vocabulary.forEach((voc, i) => {
        const stat = results[i];
        if (stat) {
          const pct = stat.total > 0 ? Math.round(100 * stat.right / stat.total) : 0;
          html += `<tr><td>${voc.latin}</td><td>${stat.right}/${stat.total}</td><td>${pct}%</td></tr>`;
        }
      });
      html += `</table><button class="button" onclick="showMenu()">Zurück zum Menü</button>`;
      document.getElementById("main-menu").style.display = "none";
      document.getElementById("history-view").innerHTML = html;
      document.getElementById("history-view").style.display = "block";
    }

    function resetAllProgress() {
      if (confirm("Möchtest du wirklich den gesamten Lernfortschritt löschen?")) {
        localStorage.removeItem("vocabResults");
        localStorage.removeItem("sessionState");
        results = {};
        showMenu();
      }
    }
  </script>
</body>
</html>
